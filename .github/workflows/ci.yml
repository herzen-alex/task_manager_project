name: CI/CD with Docker Compose

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build and Test Full Project
    runs-on: ubuntu-latest
    services:
      docker:
        image: docker:24-dind
        options: --privileged

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # üîπ –ö—ç—à Python
      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend_projects/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # üîπ –ö—ç—à Node.js
      - name: Cache Node.js dependencies
        uses: actions/cache@v3
        with:
          path: frontend/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # üîπ –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤
      - name: Build Docker images
        run: docker compose build --progress=plain

      # üîπ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –≤ —Ñ–æ–Ω–µ
      - name: Start Docker Compose
        run: docker compose up -d

      # üîπ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
      - name: Wait for all services
        run: |
          echo "Waiting for all services to be ready..."
          SERVICES=$(docker compose ps --services)
          for SERVICE in $SERVICES; do
            echo "Checking $SERVICE..."
            for i in {1..30}; do
              if docker compose exec $SERVICE sh -c "exit 0" >/dev/null 2>&1; then
                echo "$SERVICE is ready!"
                break
              fi
              echo "Waiting 5s for $SERVICE..."
              sleep 5
            done
          done

      # üîπ –õ–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
      - name: Show Docker Compose logs
        run: docker compose logs --tail=50

      # üîπ –¢–µ—Å—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      - name: Run tests
        run: docker compose exec backend pytest || true

      # üîπ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
      - name: Stop Docker Compose
        if: always()
        run: docker compose down
